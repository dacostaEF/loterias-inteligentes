<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>+Milionária | Dashboard Inteligente</title>

  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>

  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      important: false,
      corePlugins: {
        preflight: false,
      },
      theme: {
        extend: {
          colors: {
            'primary': '#00E38C',
            'secondary': '#8B5CF6',
            'background': '#000000', // Certifique-se que esta é a cor de fundo desejada
            'card': '#1A1D25',
            'surface': '#2E303A',
          }
        }
      }
    }
  </script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/estilo.css') }}">

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

</head>
<body class="p-4 sm:p-6">
  <!-- Header -->
  <header class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-2xl sm:text-3xl font-bold text-white">+Milionária</h1>
      <p class="text-sm sm:text-base text-gray-400">Dashboard Inteligente de Análise Estatística</p>
    </div>
    
    <!-- Logo centralizada -->
    <div class="flex justify-center items-center">
      <img src="/static/img/Logo_LoteriasIntelitente.png" alt="Logo Loterias Inteligente" class="max-w-[120px] sm:max-w-[150px] md:max-w-[180px]">
    </div>
    
    <button class="bg-[#8B5CF6] px-4 py-2 rounded-xl font-semibold hover:opacity-80 transition-all text-sm sm:text-base">
      Login / Criar Conta
    </button>
  </header>

  <!-- Cartão de jogo -->
  <section class="bg-[#1A1D25] p-6 rounded-2xl shadow-md mb-8 flex flex-col">
    <h2 class="text-xl font-semibold mb-4">🎯 Selecione de 1 a 6 números entre 50</h2>
    <div class="grid grid-cols-10 gap-2 mb-6" id="numeros-container">
      <!-- Números serão gerados dinamicamente -->
    </div>

    <!-- Container único de trevos -->
    <div class="mt-6">
      <h3 class="text-lg mb-2 text-center"><img src="/static/img/trevo4folhas.webp" alt="Trevo" class="inline w-4 h-4 mr-1"> Selecione de 2 a 6 Trevos</h3>
      <div class="flex gap-4 flex-wrap justify-center" id="trevos-container">
        <!-- Trevos serão gerados dinamicamente -->
      </div>
    </div>

    <!-- Números selecionados -->
    <div class="mt-6 p-4 bg-[#2E303A] rounded-xl">
      <div class="grid grid-cols-3 gap-6">
        <!-- Coluna 1: Números principais -->
        <div>
          <h4 class="text-sm font-semibold mb-2">Números Selecionados:</h4>
          <div class="flex gap-2 flex-wrap" id="numeros-selecionados">
            <span class="text-gray-400">Nenhum número selecionado</span>
          </div>
        </div>
        
        <!-- Coluna 2: Trevos -->
        <div>
          <h4 class="text-sm font-semibold mb-2">Trevos Selecionados:</h4>
          <div class="flex gap-2 flex-wrap" id="trevos-selecionados">
            <span class="text-gray-400">Nenhum trevo selecionado</span>
          </div>
        </div>
        
        <!-- Coluna 3: Valor da aposta -->
        <div class="flex flex-col justify-center items-center">
          <div id="valor-aposta-container" class="text-center">
            <div class="text-gray-400 text-sm">Aposta não configurada</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Container específico para o Gerador de Números +Milionária -->
    <div class="gerador-container mt-6 p-6 bg-[#1A1D25] rounded-xl shadow-md">
      <h3 class="text-lg font-semibold mb-4 text-center">🎯 Gerador de Números +Milionária</h3>
                      <p class="text-gray-400 text-center mb-4 text-sm">Opções para gerar seus palpites</p>
      
      <div class="botoes-mobile-ajustados">
        <button class="bg-[#00E38C] text-black font-bold px-6 py-3 rounded-xl hover:opacity-80 transition-all text-sm" onclick="abrirModalConfiguracao()">
          🍀 Gerar Palpite da Sorte
        </button>
      
        <button class="bg-gray-600 text-gray-400 font-bold px-6 py-3 rounded-xl cursor-not-allowed text-sm" disabled>
          📊 Análise Estatística<br><small class="texto-premium">PREMIUM</small>
        </button>
      
        <button class="bg-red-600 text-white font-bold px-6 py-3 rounded-xl hover:opacity-80 transition-all text-sm" onclick="limparSelecao()">
          🗑️ Limpar Tudo<br><small>&nbsp;</small>
        </button>
      </div>
      
      <div class="mt-4 text-center">
        <p class="text-xs text-gray-500">
                                  💡 Experimente o gerador de Palpite da Sorte!
        </p>
      </div>
    </div>

    <!-- Botões de análise -->
    <div class="mt-8 flex flex-wrap gap-4">
      <button class="bg-[#00E38C] text-black font-semibold px-4 py-2 rounded-xl hover:opacity-80 transition-all text-sm sm:text-base" onclick="abrirModal('frequencia')">
        📊 Frequência
      </button>
      <button class="bg-[#00E38C] text-black font-semibold px-4 py-2 rounded-xl hover:opacity-80 transition-all text-sm sm:text-base" onclick="abrirModal('distribuicao')">
        🔢 Distribuição
      </button>
      <button class="bg-[#00E38C] text-black font-semibold px-4 py-2 rounded-xl hover:opacity-80 transition-all text-sm sm:text-base" onclick="abrirModal('afinidades')">
        🤝 Afinidades
      </button>
      <button class="bg-[#00E38C] text-black font-semibold px-4 py-2 rounded-xl hover:opacity-80 transition-all text-sm sm:text-base" onclick="abrirModal('trevos')">
        <img src="/static/img/trevo4folhas.webp" alt="Trevo" class="inline w-4 h-4 mr-1"> Trevos
      </button>
      <button class="bg-[#00E38C] text-black font-semibold px-4 py-2 rounded-xl hover:opacity-80 transition-all text-sm sm:text-base" onclick="abrirModal('seca')">
        🌵 Seca
      </button>
      <button class="bg-[#00E38C] text-black font-semibold px-4 py-2 rounded-xl hover:opacity-80 transition-all text-sm sm:text-base" onclick="abrirModal('estatisticas')">
        📈 Estatísticas Avançadas
      </button>
    </div>
  </section>

  <!-- Seção de Estatísticas Rápidas -->
  <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="stat-card p-6 rounded-2xl">
      <h3 class="text-lg font-semibold mb-2">🔥 Números Quentes</h3>
      <div class="text-sm text-gray-300" id="numeros-quentes">
        Carregando...
      </div>
    </div>
    <div class="stat-card p-6 rounded-2xl">
      <h3 class="text-lg font-semibold mb-2">❄️ Números Frios</h3>
      <div class="text-sm text-gray-300" id="numeros-frios">
        Carregando...
      </div>
    </div>
    <div class="stat-card p-6 rounded-2xl">
      <h3 class="text-lg font-semibold mb-2"><img src="/static/img/trevo4folhas.webp" alt="Trevo" class="inline w-4 h-4 mr-1"> Trevos Mais Frequentes</h3>
      <div class="text-sm text-gray-300" id="trevos-frequentes">
        Carregando...
      </div>
    </div>
  </section>



  <!-- Modal base -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-[#1A1D25] p-8 rounded-2xl w-full max-w-6xl relative modal-content">
      <button class="absolute top-4 right-4 w-8 h-8 bg-[#2E303A] hover:bg-[#3E404A] text-white text-lg font-semibold rounded-full flex items-center justify-center transition-all duration-200 hover:scale-110 shadow-lg" onclick="fecharModal()" title="Fechar">✕</button>
      <h2 id="titulo-modal" class="text-2xl font-semibold mb-4">Título do Modal</h2>
      <div id="conteudo-modal" class="text-gray-300">
        Carregando análise...
      </div>
    </div>
  </div>

  <!-- Modal de Configuração de Aposta -->
  <div id="modalConfiguracao" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-[#1A1D25] p-8 rounded-2xl shadow-xl w-96 text-white">
      <h3 class="text-xl font-bold mb-6 text-center text-[#00E38C]">🎲 Configurar Aposta Aleatória</h3>

      <div class="mb-5">
        <label for="sliderNumeros" class="block text-gray-300 text-sm font-semibold mb-2">Quantos números principais? (6-12)</label>
        <input type="range" id="sliderNumeros" min="6" max="12" value="8" class="w-full h-2 bg-[#2E303A] rounded-lg appearance-none cursor-pointer range-lg">
        <span id="valorNumeros" class="block text-center text-lg font-bold mt-2 text-[#00E38C]">8</span>
      </div>

      <div class="mb-8">
        <label for="sliderTrevos" class="block text-gray-300 text-sm font-semibold mb-2">🍀 Quantos números para Trevos? (2-6)</label>
        <input type="range" id="sliderTrevos" min="2" max="6" value="2" class="w-full h-2 bg-[#2E303A] rounded-lg appearance-none cursor-pointer range-lg">
        <span id="valorTrevos" class="block text-center text-lg font-bold mt-2 text-[#8B5CF6]">2</span>
      </div>

      <div class="flex justify-end space-x-4">
        <button id="btnCancelarModal" class="bg-gray-600 text-white px-4 py-2 rounded-xl font-semibold hover:opacity-80 transition-all">Cancelar</button>
        <button id="btnGerarNoModal" class="bg-[#00E38C] text-black px-4 py-2 rounded-xl font-semibold hover:opacity-80 transition-all">Gerar Aposta</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Dados simulados (serão substituídos pelos dados reais)
    const dadosMilionaria = {
      frequencia: {
        numeros: {
          quentes: [21, 41, 50, 23, 44, 16, 35, 42, 47, 48],
          frios: [49, 43, 45, 46, 40, 39, 38, 37, 36, 34]
        },
        trevos: {
          frequentes: [2, 4, 1, 6, 3, 5]
        }
      },
      distribuicao: {
        pares: 3.04,
        impares: 2.96,
        faixas: {
          "1-10": 0.8,
          "11-20": 1.2,
          "21-30": 1.1,
          "31-40": 1.3,
          "41-50": 1.6
        }
      },
      afinidades: {
        positivas: [
          { num1: 21, num2: 22, correlacao: 0.182 },
          { num1: 17, num2: 46, correlacao: 0.173 },
          { num1: 4, num2: 38, correlacao: 0.155 }
        ],
        negativas: [
          { num1: 24, num2: 25, correlacao: -0.159 },
          { num1: 20, num2: 41, correlacao: -0.155 }
        ]
      },
      seca: {
        maior: [49, 43, 45, 46, 40],
        recentes: [21, 41, 50, 23, 44]
      }
    };

    // Variáveis globais
    let numerosSelecionados = [];
    let trevosSelecionados = []; // Array único para os 2 trevos selecionados

    // Inicialização - Aguarda carregamento completo dos estilos
    function inicializarAplicacao() {
      gerarNumeros();
      gerarTrevos();
      carregarEstatisticasRapidas();
    }

    // Aguarda tanto DOM quanto estilos carregados
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarAplicacao);
    } else {
      // DOM já carregado, aguarda estilos
      window.addEventListener('load', inicializarAplicacao);
    }
    


    // Gerar números de 1 a 50
    function gerarNumeros() {
      const container = document.getElementById('numeros-container');
      container.innerHTML = '';
      
      for (let i = 1; i <= 50; i++) {
        const div = document.createElement('div');
        div.className = 'numero p-3 rounded-xl text-center font-semibold';
        div.textContent = i.toString().padStart(2, '0');
        div.onclick = () => selecionarNumero(i, div);
        container.appendChild(div);
      }
    }

    // Gerar trevos (container único) - Versão elegante com ícones
    function gerarTrevos() {
      const container = document.getElementById('trevos-container');
      container.innerHTML = '';
      
      for (let i = 1; i <= 6; i++) {
        const div = document.createElement('div');
        div.className = 'trevo-icon-container';
        div.innerHTML = `
          <div class="trevo-icon">
            <span class="trevo-number">${i}</span>
          </div>
        `;
        div.onclick = () => selecionarTrevo(i, div);
        container.appendChild(div);
      }
    }

    // Selecionar número (manual - limite de 12)
    function selecionarNumero(numero, elemento) {
      // Verificar se já atingiu o limite antes de qualquer ação
      if (numerosSelecionados.length >= 12 && !numerosSelecionados.includes(numero)) {
        alert('Você já selecionou 12 números! Limite máximo para seleção manual.');
        // Garantir que o elemento NÃO seja marcado visualmente
        elemento.classList.remove('selecionado');
        // Forçar remoção de qualquer estado temporário
        elemento.blur();
        elemento.style.pointerEvents = 'none';
        setTimeout(() => {
          elemento.style.pointerEvents = 'auto';
        }, 100);
        return;
      }
      
      if (numerosSelecionados.includes(numero)) {
        numerosSelecionados = numerosSelecionados.filter(n => n !== numero);
        elemento.classList.remove('selecionado');
      } else {
        numerosSelecionados.push(numero);
        elemento.classList.add('selecionado');
      }
      atualizarNumerosSelecionados();
      calcularEAtualizarValorAposta(); // NOVA: Calcular valor após cada seleção
    }

    // Selecionar número automaticamente (sem limite)
    function selecionarNumeroAutomatico(numero, elemento) {
      if (!numerosSelecionados.includes(numero)) {
        numerosSelecionados.push(numero);
        elemento.classList.add('selecionado');
      }
      atualizarNumerosSelecionados();
    }

    // Selecionar trevo (manual - limite de 6 trevos)
    function selecionarTrevo(trevo, elemento) {
      // Verificar se já atingiu o limite antes de qualquer ação
      if (trevosSelecionados.length >= 6 && !trevosSelecionados.includes(trevo)) {
        alert('Você já selecionou 6 trevos! Limite máximo para seleção manual.');
        // Garantir que o elemento NÃO seja marcado visualmente
        elemento.classList.remove('selecionado');
        // Forçar remoção de qualquer estado temporário
        elemento.blur();
        elemento.style.pointerEvents = 'none';
        setTimeout(() => {
          elemento.style.pointerEvents = 'auto';
        }, 100);
        return;
      }
      
      if (trevosSelecionados.includes(trevo)) {
        trevosSelecionados = trevosSelecionados.filter(t => t !== trevo);
        elemento.classList.remove('selecionado');
      } else {
        trevosSelecionados.push(trevo);
        elemento.classList.add('selecionado');
      }
      atualizarTrevosSelecionados();
      calcularEAtualizarValorAposta(); // NOVA: Calcular valor após cada seleção
    }

    // Atualizar display dos números selecionados
    function atualizarNumerosSelecionados() {
      const container = document.getElementById('numeros-selecionados');
      if (numerosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400">Nenhum número selecionado</span>';
      } else {
        container.innerHTML = numerosSelecionados
          .sort((a, b) => a - b)
          .map(n => `<span class="bg-[#00E38C] text-black px-2 py-1 rounded font-semibold">${n.toString().padStart(2, '0')}</span>`)
          .join('');
      }
    }

    // Atualizar display dos trevos selecionados
    function atualizarTrevosSelecionados() {
      const container = document.getElementById('trevos-selecionados');
      if (trevosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400">Nenhum trevo selecionado</span>';
      } else {
        container.innerHTML = trevosSelecionados
          .sort((a, b) => a - b)
          .map(t => `<span class="bg-[#8B5CF6] text-white px-2 py-1 rounded font-semibold">${t}</span>`)
          .join('');
      }
    }

    // Atualizar display do valor da aposta
    function atualizarValorAposta(valor, qtdeApostas, qtdeNum, qtdeTrevos) {
      const container = document.getElementById('valor-aposta-container');
      if (valor && qtdeApostas) {
        const valorFormatado = new Intl.NumberFormat('pt-BR', {
          style: 'currency',
          currency: 'BRL'
        }).format(valor);
        
        container.innerHTML = `
          <div class="bg-[#00E38C] text-black p-3 rounded-xl font-bold text-lg mb-2">
            ${valorFormatado}
          </div>
          <div class="text-sm text-gray-300 mb-1">
            <strong>${qtdeApostas}</strong> combinações
          </div>
          <div class="text-xs text-gray-400">
            ${qtdeNum} números + ${qtdeTrevos} trevos
          </div>
        `;
      } else {
        container.innerHTML = '<div class="text-gray-400 text-sm">Aposta não configurada</div>';
      }
    }

    // NOVA: Calcular e atualizar valor da aposta baseado nas seleções manuais
    function calcularEAtualizarValorAposta() {
      const qtdeNum = numerosSelecionados.length;
      const qtdeTrevos = trevosSelecionados.length;
      
      // Só calcular se tiver seleção mínima (6 números + 2 trevos)
      if (qtdeNum >= 6 && qtdeTrevos >= 2) {
        // Tabela de preços simplificada para seleção manual
        const tabelaPrecos = {
          "6,2": {apostas: 1, valor: 6.00},
          "6,3": {apostas: 3, valor: 18.00},
          "6,4": {apostas: 6, valor: 36.00},
          "6,5": {apostas: 10, valor: 60.00},
          "6,6": {apostas: 15, valor: 90.00},
          "7,2": {apostas: 7, valor: 42.00},
          "7,3": {apostas: 21, valor: 126.00},
          "7,4": {apostas: 42, valor: 252.00},
          "7,5": {apostas: 70, valor: 420.00},
          "7,6": {apostas: 105, valor: 630.00},
          "8,2": {apostas: 28, valor: 168.00},
          "8,3": {apostas: 84, valor: 504.00},
          "8,4": {apostas: 168, valor: 1008.00},
          "8,5": {apostas: 280, valor: 1680.00},
          "8,6": {apostas: 420, valor: 2520.00},
          "9,2": {apostas: 84, valor: 504.00},
          "9,3": {apostas: 252, valor: 1512.00},
          "9,4": {apostas: 504, valor: 3024.00},
          "9,5": {apostas: 840, valor: 5040.00},
          "9,6": {apostas: 1260, valor: 7560.00},
          "10,2": {apostas: 210, valor: 1260.00},
          "10,3": {apostas: 630, valor: 3780.00},
          "10,4": {apostas: 1260, valor: 7560.00},
          "10,5": {apostas: 2100, valor: 12600.00},
          "10,6": {apostas: 3150, valor: 18900.00},
          "11,2": {apostas: 462, valor: 2772.00},
          "11,3": {apostas: 1386, valor: 8316.00},
          "11,4": {apostas: 2772, valor: 16632.00},
          "11,5": {apostas: 4620, valor: 27720.00},
          "11,6": {apostas: 6930, valor: 41580.00},
          "12,2": {apostas: 924, valor: 5544.00},
          "12,3": {apostas: 2772, valor: 16632.00},
          "12,4": {apostas: 5544, valor: 33264.00},
          "12,5": {apostas: 9240, valor: 55440.00},
          "12,6": {apostas: 13860, valor: 83160.00}
        };
        
        const chave = `${qtdeNum},${qtdeTrevos}`;
        const infoAposta = tabelaPrecos[chave];
        
        if (infoAposta) {
          atualizarValorAposta(infoAposta.valor, infoAposta.apostas, qtdeNum, qtdeTrevos);
        } else {
          // Se não encontrar na tabela, mostrar mensagem
          atualizarValorAposta(null, null, null, null);
        }
      } else {
        // Se não tiver seleção mínima, limpar valor
        atualizarValorAposta(null, null, null, null);
      }
    }

    // Carregar estatísticas rápidas
    function carregarEstatisticasRapidas() {
      document.getElementById('numeros-quentes').innerHTML = 
        dadosMilionaria.frequencia.numeros.quentes.slice(0, 5)
          .map(n => `<span class="bg-[#00E38C] text-black px-1 py-0.5 rounded text-xs mr-1">${n}</span>`)
          .join('');

      document.getElementById('numeros-frios').innerHTML = 
        dadosMilionaria.frequencia.numeros.frios.slice(0, 5)
          .map(n => `<span class="bg-gray-600 text-white px-1 py-0.5 rounded text-xs mr-1">${n}</span>`)
          .join('');

      document.getElementById('trevos-frequentes').innerHTML = 
        dadosMilionaria.frequencia.trevos.frequentes.slice(0, 3)
          .map(t => `<span class="bg-[#8B5CF6] text-white px-1 py-0.5 rounded text-xs mr-1">${t}</span>`)
          .join('');
    }

    // Abrir modal
    function abrirModal(tipo) {
      const modal = document.getElementById('modal');
      const titulo = document.getElementById('titulo-modal');
      const conteudo = document.getElementById('conteudo-modal');
      
      modal.classList.remove('hidden');
      
      switch(tipo) {
        case 'frequencia':
          titulo.textContent = '📊 Análise de Frequência';
          carregarAnaliseFrequencia(conteudo);
          break;
        case 'distribuicao':
          titulo.textContent = '🔢 Análise de Distribuição';
          carregarAnaliseDistribuicao(conteudo);
          break;
        case 'afinidades':
          titulo.textContent = '🤝 Análise de Afinidades';
          carregarAnaliseAfinidades(conteudo);
          break;
        case 'trevos':
          titulo.textContent = '🍀 Análise dos Trevos';
          carregarAnaliseTrevos(conteudo);
          break;
        case 'seca':
          titulo.textContent = '🌵 Análise de Seca';
          carregarAnaliseSeca(conteudo);
          break;
        case 'estatisticas':
          titulo.textContent = '📈 Estatísticas Avançadas';
          carregarEstatisticasAvancadas(conteudo);
          break;
      }
    }

    // Fechar modal
    function fecharModal() {
      document.getElementById('modal').classList.add('hidden');
    }

    // Carregar análise de frequência
    async function carregarAnaliseFrequencia(container) {
      container.innerHTML = "🔄 Carregando análise de frequência...";

      try {
        const response = await fetch('/api/analise-frequencia');
        const data = await response.json();

        if (data.error) {
          container.innerHTML = `<p style="color: red;">Erro: ${data.error}</p>`;
          return;
        }

        container.innerHTML = `
          <div class="space-y-6">
            <!-- Cabeçalho com título e ajuda -->
            <div class="flex justify-between items-start">
              <div class="bg-[#2E303A] p-4 rounded-xl flex-1">
                <h3 class="text-lg font-semibold mb-3 text-[#00E38C]">🎯 Janela de Análise Temporal</h3>
                <div class="flex flex-wrap gap-3 items-center">
                  <label class="text-sm text-gray-300">Período:</label>
                  <select id="janela-analise" class="bg-[#1A1D25] text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-[#00E38C] focus:outline-none" onchange="atualizarAnaliseFrequencia()">
                    <option value="">Todos os concursos</option>
                    <option value="25">Últimos 25 concursos</option>
                    <option value="50">Últimos 50 concursos</option>
                    <option value="100">Últimos 100 concursos</option>
                    <option value="200">Últimos 200 concursos</option>
                  </select>
                  <span class="text-xs text-gray-400">(Selecione para atualizar a análise)</span>
                </div>
              </div>
              <button onclick="abrirPopupAjuda()" class="ml-4 bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg transition-colors duration-200" title="Como usar estes gráficos?">
                ❓
              </button>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🔥 Números Mais Quentes (Top 10)</h3>
              <div class="grid grid-cols-5 gap-2">
                ${data.numeros_quentes.slice(0, 10).map(n => 
                  `<div class="bg-[#00E38C] text-black p-3 rounded text-center font-semibold">${n[0]}</div>`
                ).join('')}
              </div>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">❄️ Números Mais Frios (Top 10)</h3>
              <div class="grid grid-cols-5 gap-2">
                ${data.numeros_frios.slice(0, 10).map(n => 
                  `<div class="bg-gray-600 text-white p-3 rounded text-center font-semibold">${n[0]}</div>`
                ).join('')}
              </div>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📊 Gráfico de Frequência Absoluta</h3>
              <div id="grafico-frequencia" style="height: 400px;"></div>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📈 Gráfico de Frequência Relativa (%)</h3>
              <div id="grafico-frequencia-relativa" style="height: 400px;"></div>
            </div>
          </div>
        `;
        
        // Criar gráfico absoluto com Plotly
        const xNumeros = data.frequencia_absoluta_numeros.map(e => e.numero);
        const yFreq = data.frequencia_absoluta_numeros.map(e => e.frequencia);

        Plotly.newPlot('grafico-frequencia', [{
          x: xNumeros,
          y: yFreq,
          type: 'bar',
          marker: { color: 'deepskyblue' }
        }], {
          title: 'Frequência Absoluta dos Números',
          paper_bgcolor: '#1a1a1a',
          plot_bgcolor: '#1a1a1a',
          font: { color: 'white' },
          autosize: true,
          responsive: true,
          margin: { l: 40, r: 20, t: 40, b: 40, pad: 5 },
          xaxis: { automargin: true },
          yaxis: { automargin: true }
        }, { displayModeBar: false });

        // Criar gráfico relativo com Plotly
        const xNumerosRel = data.frequencia_relativa_numeros.map(e => e.numero);
        const yFreqRel = data.frequencia_relativa_numeros.map(e => e.frequencia);
        const linhaEsperada = Array(50).fill(2); // Linha de referência 2%

        Plotly.newPlot('grafico-frequencia-relativa', [
          {
            x: xNumerosRel,
            y: yFreqRel,
            type: 'bar',
            name: 'Frequência Relativa',
            marker: { color: '#00E38C' }
          },
          {
            x: xNumerosRel,
            y: linhaEsperada,
            type: 'scatter',
            mode: 'lines',
            name: 'Esperado (2%)',
            line: { color: 'red', dash: 'dash' }
          }
        ], {
          title: 'Frequência Relativa dos Números (%)',
          paper_bgcolor: '#1a1a1a',
          plot_bgcolor: '#1a1a1a',
          font: { color: 'white' },
          yaxis: { automargin: true }, // Remove título do eixo Y
          xaxis: { automargin: true }, // Remove título do eixo X
          showlegend: false, // Remove legenda
          autosize: true,
          responsive: true,
          margin: { l: 40, r: 20, t: 40, b: 40, pad: 5 }
        }, { 
          displayModeBar: false,
          scrollZoom: false
        });

      } catch (error) {
        container.innerHTML = `<p style="color: red;">Erro ao carregar dados: ${error.message}</p>`;
      }
    }

    // Função para atualizar análise quando mudar a janela
    async function atualizarAnaliseFrequencia() {
      const janela = document.getElementById('janela-analise').value;
      const container = document.getElementById('conteudo-modal');
      
      container.innerHTML = "🔄 Atualizando análise...";

      try {
        const url = janela ? `/api/analise-frequencia?qtd_concursos=${janela}` : '/api/analise-frequencia';
        const response = await fetch(url);
        const data = await response.json();

        if (data.error) {
          container.innerHTML = `<p style="color: red;">Erro: ${data.error}</p>`;
          return;
        }

        // Recriar o conteúdo com os novos dados
        container.innerHTML = `
          <div class="space-y-6">
            <!-- Cabeçalho com título e ajuda -->
            <div class="flex justify-between items-start">
              <div class="bg-[#2E303A] p-4 rounded-xl flex-1">
                <h3 class="text-lg font-semibold mb-3 text-[#00E38C]">🎯 Janela de Análise</h3>
                <div class="flex flex-wrap gap-3 items-center">
                  <label class="text-sm text-gray-300">Período:</label>
                  <select id="janela-analise" class="bg-[#1A1D25] text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-[#00E38C] focus:outline-none" onchange="atualizarAnaliseFrequencia()">
                    <option value="" ${janela === '' ? 'selected' : ''}>Todos os concursos</option>
                    <option value="25" ${janela === '25' ? 'selected' : ''}>Últimos 25 concursos</option>
                    <option value="50" ${janela === '50' ? 'selected' : ''}>Últimos 50 concursos</option>
                    <option value="100" ${janela === '100' ? 'selected' : ''}>Últimos 100 concursos</option>
                    <option value="200" ${janela === '200' ? 'selected' : ''}>Últimos 200 concursos</option>
                  </select>
                  <span class="text-xs text-gray-400">(Selecione para atualizar a análise)</span>
                </div>
              </div>
              <button onclick="abrirPopupAjuda()" class="ml-4 bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg transition-colors duration-200" title="Como usar estes gráficos?">
                ❓
              </button>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🔥 Números Mais Quentes (Top 10)</h3>
              <div class="grid grid-cols-5 gap-2">
                ${data.numeros_quentes.slice(0, 10).map(n => 
                  `<div class="bg-[#00E38C] text-black p-3 rounded text-center font-semibold">${n[0]}</div>`
                ).join('')}
              </div>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">❄️ Números Mais Frios (Top 10)</h3>
              <div class="grid grid-cols-5 gap-2">
                ${data.numeros_frios.slice(0, 10).map(n => 
                  `<div class="bg-gray-600 text-white p-3 rounded text-center font-semibold">${n[0]}</div>`
                ).join('')}
              </div>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📊 Gráfico de Frequência Absoluta</h3>
              <div id="grafico-frequencia" style="height: 400px;"></div>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📈 Gráfico de Frequência Relativa (%)</h3>
              <div id="grafico-frequencia-relativa" style="height: 400px;"></div>
            </div>
          </div>
        `;
        
        // Recriar gráfico absoluto com novos dados
        const xNumeros = data.frequencia_absoluta_numeros.map(e => e.numero);
        const yFreq = data.frequencia_absoluta_numeros.map(e => e.frequencia);

        Plotly.newPlot('grafico-frequencia', [{
          x: xNumeros,
          y: yFreq,
          type: 'bar',
          marker: { color: 'deepskyblue' }
        }], {
          title: `Frequência Absoluta dos Números ${janela ? `(Últimos ${janela} concursos)` : '(Todos os concursos)'}`,
          paper_bgcolor: '#1a1a1a',
          plot_bgcolor: '#1a1a1a',
          font: { color: 'white' },
          autosize: true,
          responsive: true,
          margin: { l: 40, r: 20, t: 40, b: 40, pad: 5 },
          xaxis: { automargin: true },
          yaxis: { automargin: true }
        }, { displayModeBar: false });

        // Recriar gráfico relativo com novos dados
        const xNumerosRel = data.frequencia_relativa_numeros.map(e => e.numero);
        const yFreqRel = data.frequencia_relativa_numeros.map(e => e.frequencia);
        const linhaEsperada = Array(50).fill(2); // Linha de referência 2%

        Plotly.newPlot('grafico-frequencia-relativa', [
          {
            x: xNumerosRel,
            y: yFreqRel,
            type: 'bar',
            name: 'Frequência Relativa',
            marker: { color: '#00E38C' }
          },
          {
            x: xNumerosRel,
            y: linhaEsperada,
            type: 'scatter',
            mode: 'lines',
            name: 'Esperado (2%)',
            line: { color: 'red', dash: 'dash' }
          }
        ], {
          title: `Frequência Relativa dos Números (%) ${janela ? `(Últimos ${janela} concursos)` : '(Todos os concursos)'}`,
          paper_bgcolor: '#1a1a1a',
          plot_bgcolor: '#1a1a1a',
          font: { color: 'white' },
          yaxis: { automargin: true }, // Remove título do eixo Y
          xaxis: { automargin: true }, // Remove título do eixo X
          showlegend: false, // Remove legenda
          autosize: true,
          responsive: true,
          margin: { l: 40, r: 20, t: 40, b: 40, pad: 5 }
        }, { 
          displayModeBar: false,
          scrollZoom: false
        });

              } catch (error) {
          container.innerHTML = `<p style="color: red;">Erro ao atualizar dados: ${error.message}</p>`;
        }
      }

      // Funções para o popup de ajuda
      function abrirPopupAjuda() {
        document.getElementById("popupAjuda").style.display = "block";
      }

      function fecharPopupAjuda() {
        document.getElementById("popupAjuda").style.display = "none";
      }

      // Funções para o popup de ajuda de distribuição
      function abrirPopupAjudaDistribuicao() {
        document.getElementById("popupAjudaDistribuicao").style.display = "block";
      }

      function fecharPopupAjudaDistribuicao() {
        document.getElementById("popupAjudaDistribuicao").style.display = "none";
      }

      // Funções para o popup de ajuda de afinidades
      function abrirPopupAjudaAfinidades() {
        document.getElementById("popupAjudaAfinidades").style.display = "block";
      }

      function fecharPopupAjudaAfinidades() {
        document.getElementById("popupAjudaAfinidades").style.display = "none";
      }

    // Carregar análise de distribuição
    async function carregarAnaliseDistribuicao(container) {
      container.innerHTML = "🔄 Carregando análise de distribuição...";

      try {
        console.log("Iniciando fetch para /api/analise_de_distribuicao...");
        const response = await fetch('/api/analise_de_distribuicao');
        console.log("Response status:", response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log("Dados recebidos:", data);

        if (data.error) {
          container.innerHTML = `<p style="color: red;">Erro: ${data.error}</p>`;
          return;
        }

        // Renderizar gráficos de distribuição
        container.innerHTML = `
          <div class="space-y-6">
            <!-- Cabeçalho com título e ajuda -->
            <div class="flex justify-between items-start">
              <div class="bg-[#2E303A] p-4 rounded-xl flex-1">
                <h3 class="text-lg font-semibold mb-3 text-[#00E38C]">🔢 Análise de Distribuição Estatística</h3>
                <p class="text-sm text-gray-300">Análise completa de paridade, somas e amplitude dos números sorteados</p>
              </div>
              <button onclick="abrirPopupAjudaDistribuicao()" class="ml-4 bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg transition-colors duration-200" title="Como usar estes gráficos?">
                ❓
              </button>
            </div>
            
            <!-- Gráfico de Paridade - Números Principais -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🔢 Paridade - Números Principais</h3>
              <div id="grafico-paridade-numeros" style="height: 400px;"></div>
            </div>
            
            <!-- Gráfico de Paridade - Trevos -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🍀 Paridade - Trevos</h3>
              <div id="grafico-paridade-trevos" style="height: 400px;"></div>
            </div>
            
            <!-- Estatísticas de Paridade -->
            <div class="grid grid-cols-2 gap-4">
              <div class="stat-card p-4">
                <h4 class="font-semibold mb-2">📊 Números Principais</h4>
                <p class="text-sm text-gray-400">Média de Pares: <span class="text-[#00E38C]">${data.paridade.numeros_principais.media_pares.toFixed(2)}</span></p>
                <p class="text-sm text-gray-400">Média de Ímpares: <span class="text-[#00E38C]">${data.paridade.numeros_principais.media_impares.toFixed(2)}</span></p>
              </div>
              <div class="stat-card p-4">
                <h4 class="font-semibold mb-2">🍀 Trevos</h4>
                <p class="text-sm text-gray-400">Média de Pares: <span class="text-[#00E38C]">${data.paridade.trevos.media_pares.toFixed(2)}</span></p>
                <p class="text-sm text-gray-400">Média de Ímpares: <span class="text-[#00E38C]">${data.paridade.trevos.media_impares.toFixed(2)}</span></p>
              </div>
            </div>
            
            <!-- Gráfico de Soma - Números Principais -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📊 Soma dos Números Principais</h3>
              <div id="grafico-soma-numeros" style="height: 400px;"></div>
            </div>
            
            <!-- Gráfico de Soma - Trevos -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🍀 Soma dos Trevos</h3>
              <div id="grafico-soma-trevos" style="height: 400px;"></div>
            </div>
            
            <!-- Estatísticas de Soma -->
            <div class="grid grid-cols-2 gap-4">
              <div class="stat-card p-4">
                <h4 class="font-semibold mb-2">📊 Soma Números Principais</h4>
                <p class="text-sm text-gray-400">Mín: <span class="text-[#00E38C]">${data.soma_dos_numeros.numeros_principais.min}</span></p>
                <p class="text-sm text-gray-400">Máx: <span class="text-[#00E38C]">${data.soma_dos_numeros.numeros_principais.max}</span></p>
                <p class="text-sm text-gray-400">Média: <span class="text-[#00E38C]">${data.soma_dos_numeros.numeros_principais.media}</span></p>
                <p class="text-sm text-gray-400">Moda: <span class="text-[#00E38C]">${data.soma_dos_numeros.numeros_principais.moda}</span></p>
              </div>
              <div class="stat-card p-4">
                <h4 class="font-semibold mb-2">🍀 Soma Trevos</h4>
                <p class="text-sm text-gray-400">Mín: <span class="text-[#00E38C]">${data.soma_dos_numeros.trevos.min}</span></p>
                <p class="text-sm text-gray-400">Máx: <span class="text-[#00E38C]">${data.soma_dos_numeros.trevos.max}</span></p>
                <p class="text-sm text-gray-400">Média: <span class="text-[#00E38C]">${data.soma_dos_numeros.trevos.media}</span></p>
                <p class="text-sm text-gray-400">Moda: <span class="text-[#00E38C]">${data.soma_dos_numeros.trevos.moda}</span></p>
              </div>
            </div>
            
            <!-- Gráfico de Amplitude - Números Principais -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📏 Amplitude dos Números Principais</h3>
              <div id="grafico-amplitude-numeros" style="height: 400px;"></div>
            </div>
            
            <!-- Estatísticas de Amplitude -->
            <div class="grid grid-cols-1 gap-4">
              <div class="stat-card p-4">
                <h4 class="font-semibold mb-2">📏 Amplitude (Maior - Menor Número)</h4>
                <p class="text-sm text-gray-400">Mín: <span class="text-[#00E38C]">${data.amplitude_dos_numeros.min}</span></p>
                <p class="text-sm text-gray-400">Máx: <span class="text-[#00E38C]">${data.amplitude_dos_numeros.max}</span></p>
                <p class="text-sm text-gray-400">Média: <span class="text-[#00E38C]">${data.amplitude_dos_numeros.media}</span></p>
                <p class="text-sm text-gray-400">Moda: <span class="text-[#00E38C]">${data.amplitude_dos_numeros.moda}</span></p>
              </div>
            </div>
          </div>
        `;

        // Verificar estrutura dos dados
        console.log("Estrutura dos dados:", {
          temParidade: !!data.paridade,
          paridadeKeys: data.paridade ? Object.keys(data.paridade) : 'N/A',
          numerosPrincipais: data.paridade?.numeros_principais,
          trevos: data.paridade?.trevos
        });

        // Criar gráficos
        criarGraficoParidadeNumeros(data.paridade.numeros_principais.distribuicao);
        criarGraficoParidadeTrevos(data.paridade.trevos.distribuicao);
        criarGraficoSomaNumeros(data.soma_dos_numeros.numeros_principais);
        criarGraficoSomaTrevos(data.soma_dos_numeros.trevos);
        criarGraficoAmplitude(data.amplitude_dos_numeros);

        console.log("Dados de distribuição recebidos:", data);
        
      } catch (error) {
        console.error('Erro ao carregar análise de distribuição:', error);
        container.innerHTML = '<p class="text-center text-red-500 mt-4">Erro ao carregar a análise de distribuição. Verifique o console para detalhes.</p>';
      }
    }

    // Função para criar o Gráfico de Barras de Paridade dos Números Principais
    function criarGraficoParidadeNumeros(dataDistribuicao) {
      // Converte o objeto de distribuição em arrays para Plotly
      const labels = Object.keys(dataDistribuicao);
      const values = Object.values(dataDistribuicao);

      const data = [{
        x: labels,
        y: values,
        type: 'bar',
        marker: {
          color: labels.map(label => {
            // Cores baseadas nas combinações P/I
            if (label.includes('6P')) return '#4CAF50'; // Mais pares
            if (label.includes('0P')) return '#F44336'; // Mais ímpares
            if (label.includes('3P-3I')) return '#2196F3'; // Equilíbrio
            return '#9C27B0'; // Outros
          })
        }
      }];

      const layout = {
        title: 'Distribuição de Paridade (Números Principais)',
        xaxis: { title: 'Combinação Par/Ímpar', automargin: true },
        yaxis: { title: 'Contagem', automargin: true },
        plot_bgcolor: '#1a1d25',
        paper_bgcolor: '#1a1d25',
        font: {
          color: '#FFFFFF'
        },
        responsive: true,
        margin: { t: 50, b: 50, l: 50, r: 20 }
      };

      Plotly.newPlot('grafico-paridade-numeros', data, layout);
    }

    // Função para criar o Gráfico de Pizza de Paridade dos Trevos
    function criarGraficoParidadeTrevos(dataDistribuicao) {
      // Converte o objeto de distribuição em arrays para Plotly
      const labels = Object.keys(dataDistribuicao);
      const values = Object.values(dataDistribuicao);

      const data = [{
        labels: labels,
        values: values,
        type: 'pie',
        marker: {
          colors: ['#8B5CF6', '#A78BFA', '#C4B5FD', '#DDD6FE']
        },
        hoverinfo: 'label+percent',
        textinfo: 'percent',
        textposition: 'inside'
      }];

      const layout = {
        title: 'Distribuição de Paridade (Trevos da Sorte)',
        plot_bgcolor: '#1a1d25',
        paper_bgcolor: '#1a1d25',
        font: {
          color: '#FFFFFF'
        },
        responsive: true,
        margin: { t: 50, b: 50, l: 50, r: 20 }
      };

      Plotly.newPlot('grafico-paridade-trevos', data, layout);
    }

    // Função para criar o Gráfico de Soma dos Números Principais
    function criarGraficoSomaNumeros(dadosSoma) {
      const minSoma = dadosSoma.min;
      const maxSoma = dadosSoma.max;
      const mediaSoma = dadosSoma.media;
      const modaSoma = dadosSoma.moda;
      const somas = dadosSoma.somas; // Lista real de somas históricas

      const data = [{
        x: somas,
        type: 'histogram',
        marker: {
          color: '#8B5CF6'
        },
        xbins: {
          size: 5
        },
        opacity: 0.75,
        name: 'Contagem de Somas'
      }];

      const layout = {
        title: 'Distribuição da Soma dos 6 Números Principais',
        xaxis: { title: 'Soma dos Números', automargin: true },
        yaxis: { title: 'Frequência', automargin: true },
        plot_bgcolor: '#1a1d25',
        paper_bgcolor: '#1a1d25',
        font: {
          color: '#FFFFFF'
        },
        responsive: true,
        margin: { t: 50, b: 50, l: 50, r: 20 },
        annotations: [
          {
            xref: 'paper', yref: 'paper',
            x: 0.05, y: 0.95,
            text: `Min: ${minSoma}<br>Max: ${maxSoma}<br>Média: ${mediaSoma}<br>Moda: ${modaSoma}`,
            showarrow: false,
            align: 'left',
            font: { color: '#FFFFFF', size: 10 },
            bgcolor: 'rgba(0,0,0,0.5)',
            bordercolor: '#8B5CF6',
            borderwidth: 1,
            borderpad: 4
          }
        ]
      };

      Plotly.newPlot('grafico-soma-numeros', data, layout);
    }

    // Função para criar o Gráfico de Soma dos Trevos
    function criarGraficoSomaTrevos(dadosSomaTrevos) {
      const minSomaTrevos = dadosSomaTrevos.min;
      const maxSomaTrevos = dadosSomaTrevos.max;
      const mediaSomaTrevos = dadosSomaTrevos.media;
      const modaSomaTrevos = dadosSomaTrevos.moda;
      const somasTrevos = dadosSomaTrevos.somas; // Lista real de somas históricas

      const data = [{
        x: somasTrevos,
        type: 'histogram',
        marker: {
          color: '#FFD700'
        },
        xbins: {
          size: 1
        },
        opacity: 0.75,
        name: 'Contagem de Somas de Trevos'
      }];

      const layout = {
        title: 'Distribuição da Soma dos 2 Trevos da Sorte',
        xaxis: { title: 'Soma dos Trevos', automargin: true },
        yaxis: { title: 'Frequência', automargin: true },
        plot_bgcolor: '#1a1d25',
        paper_bgcolor: '#1a1d25',
        font: {
          color: '#FFFFFF'
        },
        responsive: true,
        margin: { t: 50, b: 50, l: 50, r: 20 },
        annotations: [
          {
            xref: 'paper', yref: 'paper',
            x: 0.05, y: 0.95,
            text: `Min: ${minSomaTrevos}<br>Max: ${maxSomaTrevos}<br>Média: ${mediaSomaTrevos}<br>Moda: ${modaSomaTrevos}`,
            showarrow: false,
            align: 'left',
            font: { color: '#FFFFFF', size: 10 },
            bgcolor: 'rgba(0,0,0,0.5)',
            bordercolor: '#FFD700',
            borderwidth: 1,
            borderpad: 4
          }
        ]
      };

      Plotly.newPlot('grafico-soma-trevos', data, layout);
    }

    // Função para criar o Gráfico de Amplitude dos Números Principais
    function criarGraficoAmplitude(dadosAmplitude) {
      const amplitudes = dadosAmplitude.amplitudes; // Lista de todas as amplitudes
      const minAmplitude = dadosAmplitude.min;
      const maxAmplitude = dadosAmplitude.max;
      const mediaAmplitude = dadosAmplitude.media;
      const modaAmplitude = dadosAmplitude.moda;

      const data = [{
        x: amplitudes,
        type: 'histogram',
        marker: {
          color: '#00BFFF' // Um tom de azul claro
        },
        xbins: {
          size: 2 // Agrupa amplitudes em intervalos de 2, ajuste conforme necessário
        },
        opacity: 0.75,
        name: 'Contagem de Amplitudes'
      }];

      const layout = {
        title: 'Distribuição da Amplitude dos 6 Números Principais',
        xaxis: { title: 'Amplitude (Maior - Menor Número)', automargin: true },
        yaxis: { title: 'Frequência', automargin: true },
        plot_bgcolor: '#1a1d25',
        paper_bgcolor: '#1a1d25',
        font: {
          color: '#FFFFFF'
        },
        responsive: true,
        margin: { t: 50, b: 50, l: 50, r: 20 },
        annotations: [
          {
            xref: 'paper', yref: 'paper',
            x: 0.05, y: 0.95, // Posição superior esquerda
            text: `Min: ${minAmplitude}<br>Max: ${maxAmplitude}<br>Média: ${mediaAmplitude.toFixed(2)}<br>Moda: ${modaAmplitude}`,
            showarrow: false,
            align: 'left',
            font: { color: '#FFFFFF', size: 10 },
            bgcolor: 'rgba(0,0,0,0.5)',
            bordercolor: '#00BFFF',
            borderwidth: 1,
            borderpad: 4
          }
        ]
      };

      Plotly.newPlot('grafico-amplitude-numeros', data, layout);
    }

    // Carregar análise de afinidades
    async function carregarAnaliseAfinidades(container, qtdConcursos = null) {
      container.innerHTML = "🔄 Carregando análise de afinidades...";

      try {
        let url = '/api/analise_de_combinacoes';
        if (qtdConcursos !== null && qtdConcursos !== '') {
          url += `?qtd_concursos=${qtdConcursos}`;
        }

        console.log("=== REQUISIÇÃO AFINIDADES ===");
        console.log("URL:", url);
        console.log("qtdConcursos:", qtdConcursos);

        const response = await fetch(url);
        const data = await response.json();

        console.log("=== DADOS RECEBIDOS DO BACKEND ===");
        console.log("Data completo:", data);
        console.log("Afinidade entre números:", data.afinidade_entre_numeros);

        if (data.error) {
          container.innerHTML = `<p style="color: red;">Erro: ${data.error}</p>`;
          return;
        }

        const afinidades = data.afinidade_entre_numeros;
        const periodoInfo = data.periodo_analisado;
        
        // Debug específico da tabela
        console.log("=== DEBUG TABELA DETALHADA ===");
        console.log("Período solicitado:", qtdConcursos);
        console.log("Período analisado:", periodoInfo);
        console.log("Pares com maior afinidade:", afinidades.pares_com_maior_afinidade);
        console.log("Primeiros 5 pares:", afinidades.pares_com_maior_afinidade.slice(0, 5));
        console.log("Frequências dos primeiros 5 pares:", afinidades.pares_com_maior_afinidade.slice(0, 5).map(p => p[1]));
        
        // Verificar se os dados estão no formato correto
        if (!afinidades || !afinidades.pares_com_maior_afinidade || !afinidades.numeros_com_maior_afinidade_geral) {
          container.innerHTML = `<p style="color: red;">Erro: Dados de afinidade incompletos ou em formato incorreto.</p>`;
          return;
        }

        container.innerHTML = `
          <div class="space-y-6">
            <!-- Cabeçalho com título e ajuda -->
            <div class="flex justify-between items-start">
              <div class="bg-[#2E303A] p-4 rounded-xl flex-1">
                <h3 class="text-lg font-semibold mb-3 text-[#00E38C]">🎯 Janela de Análise Temporal</h3>
                <div class="flex flex-wrap gap-3 items-center">
                  <label class="text-sm text-gray-300">Período:</label>
                  <select id="janela-analise-afinidades" class="bg-[#1A1D25] text-white px-3 py-2 rounded-lg border border-gray-600 focus:border-[#00E38C] focus:outline-none" onchange="updateAfinidadeModal()">
                    <option value="">Todos os concursos</option>
                    <option value="25">Últimos 25 concursos</option>
                    <option value="50">Últimos 50 concursos</option>
                    <option value="100">Últimos 100 concursos</option>
                    <option value="200">Últimos 200 concursos</option>
                  </select>
                  <span class="text-xs text-gray-400">(Selecione para atualizar a análise)</span>
                </div>
              </div>
              <button onclick="abrirPopupAjudaAfinidades()" class="ml-4 bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg transition-colors duration-200" title="Como usar esta análise?">
                ❓
              </button>
            </div>
            
            <!-- Top 15 Pares com Maior Afinidade -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🔗 Pares com Maior Afinidade (Top 15)</h3>
              <div class="grid grid-cols-5 gap-2">
                ${afinidades.pares_com_maior_afinidade.slice(0, 15).map(par => 
                  `<div class="bg-[#00E38C] text-black p-3 rounded text-center font-semibold">
                    <div class="text-lg">${par[0][0]} ↔ ${par[0][1]}</div>
                    <div class="text-xs">${par[1]} vezes</div>
                  </div>`
                ).join('')}
              </div>
            </div>
            
            <!-- Top 15 Números com Maior Afinidade Geral -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">⭐ Números com Maior Afinidade Geral (Top 15)</h3>
              <div class="grid grid-cols-5 gap-2">
                ${afinidades.numeros_com_maior_afinidade_geral.slice(0, 15).map(num => 
                  `<div class="bg-[#8B5CF6] text-white p-3 rounded text-center font-semibold">
                    <div class="text-lg">${num[0]}</div>
                    <div class="text-xs">${num[1]} pts</div>
                  </div>`
                ).join('')}
              </div>
            </div>
            
            <!-- Tabela Detalhada de Pares -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📋 Tabela Detalhada - Pares com Maior Afinidade</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-left table-auto border-collapse rounded-lg overflow-hidden">
                  <thead>
                    <tr class="bg-gray-800 text-gray-300 uppercase text-xs">
                      <th class="px-4 py-3 text-center">#</th>
                      <th class="px-4 py-3 text-center">Par</th>
                      <th class="px-4 py-3 text-center">Frequência</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-700">
                    ${afinidades.pares_com_maior_afinidade.slice(0, 25).map((par, i) => {
                      // Debug individual de cada par
                      console.log(`Par ${i + 1}:`, par, `Estrutura: [${par[0][0]}, ${par[0][1]}], Frequência: ${par[1]}`);
                      return `<tr class="${i % 2 === 0 ? 'bg-gray-800' : 'bg-gray-700'} hover:bg-gray-600">
                        <td class="px-4 py-2 text-center text-gray-300">${i + 1}</td>
                        <td class="px-4 py-2 text-center text-white font-bold">${par[0][0]} ↔ ${par[0][1]}</td>
                        <td class="px-4 py-2 text-center text-[#00E38C] font-semibold">${par[1]} vezes</td>
                      </tr>`;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Debug da Tabela -->
            <div class="mt-4 p-3 bg-gray-800 rounded text-xs text-gray-300">
              <strong>Debug Tabela:</strong> 
              Período: ${qtdConcursos || 'Todos'}, 
              Total de pares: ${afinidades.pares_com_maior_afinidade.length}, 
              Primeiros 3 pares: ${afinidades.pares_com_maior_afinidade.slice(0, 3).map(p => `${p[0][0]}-${p[0][1]}(${p[1]})`).join(', ')}
            </div>
            
            <!-- Gráfico de Pares com Maior Afinidade -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📊 Gráfico de Pares com Maior Afinidade</h3>
              <div id="grafico-pares-afinidade" style="height: 400px;"></div>
            </div>
            
            <!-- Gráfico de Números com Maior Afinidade Geral -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">📈 Gráfico de Afinidade Geral por Número</h3>
              <div id="grafico-afinidade-geral" style="height: 400px;"></div>
            </div>
            
            <!-- Gráfico de Rede de Afinidade -->
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🕸️ Rede de Afinidade entre Números</h3>
              <p class="text-sm text-gray-400 mb-4">Visualize as conexões entre números. Linhas mais grossas = maior afinidade</p>
              
              <!-- Legenda das cores -->
              <div class="flex justify-center gap-6 mb-4 text-xs">
                <div class="flex items-center gap-2">
                  <div class="w-4 h-1 bg-[#8B5CF6]"></div>
                  <span class="text-gray-300">Baixa afinidade</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-4 h-1 bg-[#FFA500]"></div>
                  <span class="text-gray-300">Média afinidade</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-4 h-1 bg-[#FF6B6B]"></div>
                  <span class="text-gray-300">Alta afinidade</span>
                </div>
              </div>
              
              <div id="grafico-rede-afinidade" style="height: 500px;"></div>
            </div>
            
            <!-- Dica Estratégica -->
            <div class="mt-8 p-4 bg-blue-900 bg-opacity-30 rounded-lg text-center text-blue-300 border border-blue-800 shadow">
              <span class="font-semibold">💡 Dica Estratégica:</span> Combine números com forte afinidade e alta conexão geral para aumentar suas chances de formar grupos vencedores!
            </div>
          </div>
        `;
        
        // Criar gráfico de pares com maior afinidade
        console.log("Dados de afinidade:", afinidades);
        console.log("Pares com maior afinidade:", afinidades.pares_com_maior_afinidade);
        console.log("Primeiro par:", afinidades.pares_com_maior_afinidade[0]);
        console.log("Tipo do primeiro par:", typeof afinidades.pares_com_maior_afinidade[0]);
        console.log("É array?", Array.isArray(afinidades.pares_com_maior_afinidade[0]));
        
        // Verificar se há dados válidos para o gráfico
        if (afinidades.pares_com_maior_afinidade && afinidades.pares_com_maior_afinidade.length > 0) {
          const paresLabels = afinidades.pares_com_maior_afinidade.slice(0, 15).map((par, index) => {
            console.log(`Par ${index}:`, par);
            // Verificar se o par tem a estrutura correta
            if (Array.isArray(par) && par.length >= 2 && Array.isArray(par[0])) {
              return `${par[0][0]}-${par[0][1]}`;
            } else if (Array.isArray(par) && par.length >= 2) {
              // Estrutura alternativa: [num1, num2, count]
              return `${par[0]}-${par[1]}`;
            } else {
              console.error("Estrutura de par inválida:", par);
              return `Erro-${index}`;
            }
          });
          
          const paresValues = afinidades.pares_com_maior_afinidade.slice(0, 15).map((par, index) => {
            if (Array.isArray(par) && par.length >= 2 && Array.isArray(par[0])) {
              return par[1];
            } else if (Array.isArray(par) && par.length >= 3) {
              // Estrutura alternativa: [num1, num2, count]
              return par[2];
            } else {
              console.error("Valor de par inválido:", par);
              return 0;
            }
          });
          
          console.log("Labels dos pares:", paresLabels);
          console.log("Valores dos pares:", paresValues);

          Plotly.newPlot('grafico-pares-afinidade', [{
            x: paresLabels,
            y: paresValues,
            type: 'bar',
            marker: { color: '#00E38C' }
          }], {
            title: 'Pares com Maior Afinidade',
            paper_bgcolor: '#1a1a1a',
            plot_bgcolor: '#1a1a1a',
            font: { color: 'white' },
            xaxis: { automargin: true },
            yaxis: { automargin: true },
            showlegend: false,
            autosize: true,
            responsive: true,
            margin: { l: 40, r: 20, t: 40, b: 40, pad: 5 }
          }, { displayModeBar: false });
        } else {
          console.error("Nenhum dado de pares encontrado");
          document.getElementById('grafico-pares-afinidade').innerHTML = '<p style="color: red; text-align: center;">Erro: Dados de pares não encontrados</p>';
        }

        // Criar gráfico de afinidade geral por número
        const numerosLabels = afinidades.numeros_com_maior_afinidade_geral.slice(0, 20).map(num => num[0]);
        const numerosValues = afinidades.numeros_com_maior_afinidade_geral.slice(0, 20).map(num => num[1]);

        Plotly.newPlot('grafico-afinidade-geral', [{
          x: numerosLabels,
          y: numerosValues,
          type: 'bar',
          marker: { color: '#8B5CF6' }
        }], {
          title: 'Afinidade Geral por Número',
          paper_bgcolor: '#1a1a1a',
          plot_bgcolor: '#1a1a1a',
          font: { color: 'white' },
          xaxis: { automargin: true },
          yaxis: { automargin: true },
          showlegend: false,
          autosize: true,
          responsive: true,
          margin: { l: 40, r: 20, t: 40, b: 40, pad: 5 }
        }, { displayModeBar: false });

        // Criar gráfico de rede de afinidade
        console.log("=== CRIANDO GRÁFICO DE REDE ===");
        
        // Pegar TODOS os pares para a rede (ou usar top 30 se não houver todos_pares_afinidade)
        const todosParesRede = afinidades.todos_pares_afinidade || afinidades.pares_com_maior_afinidade;
        const topParesRede = todosParesRede.slice(0, 30); // Usar top 30 para não sobrecarregar
        console.log("Total de pares disponíveis:", todosParesRede.length);
        console.log("Pares para rede (top 30):", topParesRede.length);
        
        // Criar nós (números únicos)
        const numerosUnicos = new Set();
        topParesRede.forEach(par => {
          numerosUnicos.add(par[0][0]);
          numerosUnicos.add(par[0][1]);
        });
        
        const nodes = Array.from(numerosUnicos).map(num => ({
          id: num,
          label: num.toString(),
          size: 20 + (afinidades.numeros_com_maior_afinidade_geral.find(n => n[0] === num)?.[1] || 0) / 10
        }));
        
        // Criar arestas (conexões)
        const edges = topParesRede.map((par, index) => ({
          from: par[0][0],
          to: par[0][1],
          value: par[1],
          title: `${par[0][0]} ↔ ${par[0][1]}: ${par[1]} vezes`
        }));
        
        console.log("Nós da rede:", nodes);
        console.log("Arestas da rede:", edges);
        
        // Criar dados para Plotly
        const nodeX = [];
        const nodeY = [];
        const nodeText = [];
        const nodeSize = [];
        const nodeColor = [];
        
        // Posicionar nós em círculo
        const radius = 200;
        const centerX = 0;
        const centerY = 0;
        
        nodes.forEach((node, i) => {
          const angle = (i / nodes.length) * 2 * Math.PI;
          nodeX.push(centerX + radius * Math.cos(angle));
          nodeY.push(centerY + radius * Math.sin(angle));
          nodeText.push(node.label);
          nodeSize.push(node.size);
          nodeColor.push('#00E38C');
        });
        
        // Criar arestas
        const edgeX = [];
        const edgeY = [];
        const edgeWidth = [];
        const edgeColors = [];
        
        // Calcular valores mínimos e máximos para normalização
        const maxFreq = Math.max(...edges.map(e => e.value));
        const minFreq = Math.min(...edges.map(e => e.value));
        const freqRange = maxFreq - minFreq;
        
        console.log("=== DEBUG ESPESSURA DAS LINHAS ===");
        console.log("Frequência máxima:", maxFreq);
        console.log("Frequência mínima:", minFreq);
        console.log("Range de frequências:", freqRange);
        
        edges.forEach(edge => {
          const fromNode = nodes.find(n => n.id === edge.from);
          const toNode = nodes.find(n => n.id === edge.to);
          
          if (fromNode && toNode) {
            const fromIndex = nodes.indexOf(fromNode);
            const toIndex = nodes.indexOf(toNode);
            
            edgeX.push([nodeX[fromIndex], nodeX[toIndex], null]);
            edgeY.push([nodeY[fromIndex], nodeY[toIndex], null]);
            
            // Normalizar a espessura baseada na frequência
            let normalizedWidth;
            if (freqRange === 0) {
              normalizedWidth = 3; // Se todas as frequências são iguais
            } else {
              const normalizedFreq = (edge.value - minFreq) / freqRange;
              normalizedWidth = 2 + (normalizedFreq * 8); // Espessura de 2 a 10
            }
            
            edgeWidth.push(normalizedWidth);
            
            // Cor baseada na intensidade da afinidade
            const intensity = (edge.value - minFreq) / freqRange;
            const color = intensity > 0.7 ? '#FF6B6B' : intensity > 0.4 ? '#FFA500' : '#8B5CF6';
            edgeColors.push(color);
            
            console.log(`Par ${edge.from}-${edge.to}: Frequência=${edge.value}, Espessura=${normalizedWidth.toFixed(2)}, Cor=${color}`);
          }
        });
        
        // Criar trace das arestas
        const edgeTraces = edgeX.map((x, i) => ({
          x: x,
          y: edgeY[i],
          mode: 'lines',
          line: {
            color: edgeColors[i],
            width: edgeWidth[i],
            opacity: 0.8
          },
          hoverinfo: 'text',
          hovertext: edges[i].title,
          showlegend: false
        }));
        
        // Criar trace dos nós
        const nodeTrace = {
          x: nodeX,
          y: nodeY,
          mode: 'markers+text',
          type: 'scatter',
          text: nodeText,
          textposition: 'middle center',
          marker: {
            size: nodeSize,
            color: nodeColor,
            line: {
              color: '#ffffff',
              width: 2
            }
          },
          textfont: {
            color: '#000000',
            size: 12,
            weight: 'bold'
          },
          hoverinfo: 'text',
          hovertext: nodeText.map((text, i) => `Número ${text}<br>Tamanho: ${nodeSize[i].toFixed(1)}`),
          showlegend: false
        };
        
        // Layout do gráfico
        const layout = {
          title: `Rede de Afinidade ${qtdConcursos ? `(Últimos ${qtdConcursos} concursos)` : '(Todos os concursos)'}`,
          paper_bgcolor: '#1a1a1a',
          plot_bgcolor: '#1a1a1a',
          font: { color: 'white' },
          xaxis: {
            showgrid: false,
            zeroline: false,
            showticklabels: false,
            range: [-250, 250]
          },
          yaxis: {
            showgrid: false,
            zeroline: false,
            showticklabels: false,
            range: [-250, 250]
          },
          showlegend: false,
          autosize: true,
          responsive: true,
          margin: { l: 20, r: 20, t: 40, b: 20, pad: 5 }
        };
        
        // Plotar o gráfico
        Plotly.newPlot('grafico-rede-afinidade', [nodeTrace, ...edgeTraces], layout, { displayModeBar: false });

      } catch (error) {
        container.innerHTML = `<p style="color: red;">Erro ao carregar dados: ${error.message}</p>`;
      }
    }



    // Função para atualizar o modal quando o filtro de período é alterado
    function updateAfinidadeModal() {
      const selectElement = document.getElementById('janela-analise-afinidades');
      const selectedQtd = selectElement.value;
      const container = document.getElementById('conteudo-modal');
      if (container) {
        carregarAnaliseAfinidades(container, selectedQtd);
      }
    }

    // Carregar análise de trevos
    function carregarAnaliseTrevos(container) {
      container.innerHTML = `
        <div class="space-y-6">
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">🍀 Frequência dos Trevos</h3>
            <div class="grid grid-cols-6 gap-4">
              ${dadosMilionaria.frequencia.trevos.frequentes.map((trevo, index) => 
                `<div class="bg-[#8B5CF6] text-white p-4 rounded text-center">
                  <div class="text-2xl font-bold">${trevo}</div>
                  <div class="text-sm">${index + 1}º mais frequente</div>
                </div>`
              ).join('')}
            </div>
          </div>
          
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">📊 Gráfico dos Trevos</h3>
            <div id="grafico-trevos" style="height: 400px;"></div>
          </div>
        </div>
      `;
      
      criarGraficoTrevos();
    }

    // Carregar análise de seca
    function carregarAnaliseSeca(container) {
      container.innerHTML = `
        <div class="space-y-6">
          <div class="grid grid-cols-2 gap-6">
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🌵 Números em Maior Seca</h3>
              <div class="space-y-2">
                ${dadosMilionaria.seca.maior.map((numero, index) => 
                  `<div class="flex justify-between items-center p-2 bg-[#2E303A] rounded">
                    <span class="font-semibold">${numero}</span>
                    <span class="text-red-400">${15 + index} concursos</span>
                  </div>`
                ).join('')}
              </div>
            </div>
            
            <div class="chart-container">
              <h3 class="text-lg font-semibold mb-4">🎯 Números Recentes</h3>
              <div class="space-y-2">
                ${dadosMilionaria.seca.recentes.map((numero, index) => 
                  `<div class="flex justify-between items-center p-2 bg-[#2E303A] rounded">
                    <span class="font-semibold">${numero}</span>
                    <span class="text-[#00E38C]">${index + 1} concurso(s)</span>
                  </div>`
                ).join('')}
              </div>
            </div>
          </div>
          
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">📊 Gráfico de Seca</h3>
            <div id="grafico-seca" style="height: 400px;"></div>
          </div>
        </div>
      `;
      
      criarGraficoSeca();
    }

    // Carregar estatísticas avançadas
    function carregarEstatisticasAvancadas(container) {
      container.innerHTML = `
        <div class="space-y-6">
          <div class="grid grid-cols-2 gap-6">
            <div class="stat-card p-4">
              <h4 class="font-semibold mb-2">🎲 Teste de Aleatoriedade</h4>
              <p class="text-lg font-bold text-[#00E38C]">ALEATÓRIO</p>
              <p class="text-sm text-gray-400">P-valor: 0.9916</p>
            </div>
            <div class="stat-card p-4">
              <h4 class="font-semibold mb-2">📊 Desvio Padrão</h4>
              <p class="text-lg font-bold text-[#00E38C]">6.11</p>
              <p class="text-sm text-gray-400">Coeficiente: 18.94%</p>
            </div>
          </div>
          
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">🔗 Análise de Clusters</h3>
            <div id="grafico-clusters" style="height: 400px;"></div>
          </div>
        </div>
      `;
      
      criarGraficoClusters();
    }

    // Funções para criar gráficos (simuladas)
    function criarGraficoFrequencia() {
      // Implementar gráfico real com Plotly
      console.log('Criando gráfico de frequência...');
    }

    function criarGraficoDistribuicao() {
      console.log('Criando gráfico de distribuição...');
    }

    function criarGraficoCorrelacao() {
      console.log('Criando gráfico de correlação...');
    }

    function criarGraficoTrevos() {
      console.log('Criando gráfico de trevos...');
    }

    function criarGraficoSeca() {
      console.log('Criando gráfico de seca...');
    }

    function criarGraficoClusters() {
      console.log('Criando gráfico de clusters...');
    }

    // Função para gerar números aleatórios (GRATUITO)
    async function gerarNumerosAleatorios() {
      // Capturar o botão no início da função
      const botao = event.target;
      const textoOriginal = botao.innerHTML;
      
      try {
        // Mostrar loading
        botao.innerHTML = '🍀 Gerando Palpite...';
        botao.disabled = true;
        
        // Chamar API para gerar números aleatórios
        const response = await fetch('/api/gerar-numeros-aleatorios');
        const dados = await response.json();
        
        if (dados.success) {
          // Limpar seleções anteriores (sem mostrar mensagem)
          limparSelecaoSilenciosa();
          
          // Selecionar números aleatórios
          dados.numeros.forEach(numero => {
            const elementos = document.querySelectorAll('#numeros-container .numero');
            const elemento = Array.from(elementos).find(el => el.textContent.trim() === numero.toString().padStart(2, '0'));
            if (elemento) {
              selecionarNumero(numero, elemento);
            }
          });
          
          // Selecionar trevos (corrigido para usar a nova estrutura)
          const trevoElementos = document.querySelectorAll('#trevos-container .trevo-icon-container');
          
          // Função para selecionar trevo sem validação de limite (para geração automática)
          function selecionarTrevoAutomatico(trevo, elemento) {
            if (!trevosSelecionados.includes(trevo)) {
              trevosSelecionados.push(trevo);
              elemento.classList.add('selecionado');
            }
            atualizarTrevosSelecionados();
          }
          
          // Selecionar primeiro trevo
          const trevo1Elemento = Array.from(trevoElementos).find(el => 
            el.querySelector('.trevo-number').textContent.trim() === dados.trevo1.toString()
          );
          if (trevo1Elemento) {
            selecionarTrevoAutomatico(dados.trevo1, trevo1Elemento);
          }
          
          // Selecionar segundo trevo
          const trevo2Elemento = Array.from(trevoElementos).find(el => 
            el.querySelector('.trevo-number').textContent.trim() === dados.trevo2.toString()
          );
          if (trevo2Elemento) {
            selecionarTrevoAutomatico(dados.trevo2, trevo2Elemento);
          }
          
          // Mostrar sucesso
          mostrarMensagem('🍀 Palpite da Sorte gerado com sucesso!', 'success');
        } else {
          throw new Error(dados.error || 'Erro ao gerar números');
        }
      } catch (error) {
        console.error('Erro:', error);
        mostrarMensagem('❌ Erro ao gerar números. Tente novamente.', 'error');
      } finally {
        // Restaurar botão usando a referência capturada
        botao.innerHTML = '🍀 Gerar Palpite da Sorte';
        botao.disabled = false;
      }
    }

    // Função para limpar todas as seleções (silenciosa - sem mensagem)
    function limparSelecaoSilenciosa() {
      // Limpar números selecionados
      numerosSelecionados = [];
      document.querySelectorAll('#numeros-container .numero').forEach(el => {
        el.classList.remove('selecionado');
      });
      
      // Limpar trevos (corrigido para usar a nova classe)
      trevosSelecionados = [];
      document.querySelectorAll('#trevos-container .trevo-icon-container').forEach(el => {
        el.classList.remove('selecionado');
      });
      
      // Atualizar displays
      atualizarNumerosSelecionados();
      atualizarTrevosSelecionados();
      calcularEAtualizarValorAposta(); // NOVA: Recalcular valor após limpeza
    }

    // Função para limpar todas as seleções (com mensagem)
    function limparSelecao() {
      limparSelecaoSilenciosa();
      mostrarMensagem('🗑️ Seleção limpa com sucesso!', 'info');
    }

    // Função para mostrar mensagens
    function mostrarMensagem(texto, tipo) {
      // Criar elemento de mensagem
      const mensagem = document.createElement('div');
      mensagem.className = `fixed top-4 right-4 p-4 rounded-xl text-white font-semibold z-50 transition-all duration-300 ${
        tipo === 'success' ? 'bg-green-600' :
        tipo === 'error' ? 'bg-red-600' :
        'bg-blue-600'
      }`;
      mensagem.textContent = texto;
      
      // Adicionar ao DOM
      document.body.appendChild(mensagem);
      
      // Remover após 3 segundos
      setTimeout(() => {
        mensagem.remove();
      }, 3000);
    }

    // ===== MODAL DE CONFIGURAÇÃO DE APOSTA =====
    
    // Elementos do modal
    const modalConfiguracao = document.getElementById('modalConfiguracao');
    const btnCancelarModal = document.getElementById('btnCancelarModal');
    const btnGerarNoModal = document.getElementById('btnGerarNoModal');
    const sliderNumeros = document.getElementById('sliderNumeros');
    const valorNumeros = document.getElementById('valorNumeros');
    const sliderTrevos = document.getElementById('sliderTrevos');
    const valorTrevos = document.getElementById('valorTrevos');

    // Atualiza os valores exibidos pelos sliders
    sliderNumeros.oninput = () => {
      valorNumeros.textContent = sliderNumeros.value;
    };
    sliderTrevos.oninput = () => {
      valorTrevos.textContent = sliderTrevos.value;
    };

    // Abrir o modal
    function abrirModalConfiguracao() {
      modalConfiguracao.classList.remove('hidden');
    }

    // Fechar o modal
    btnCancelarModal.addEventListener('click', () => {
      modalConfiguracao.classList.add('hidden');
    });

    // Gerar aposta ao clicar no botão dentro do modal
    btnGerarNoModal.addEventListener('click', () => {
      const qtdeNum = parseInt(sliderNumeros.value);
      const qtdeTrevos = parseInt(sliderTrevos.value);
      gerarApostaAleatoria(qtdeNum, qtdeTrevos);
      modalConfiguracao.classList.add('hidden'); // Fecha o modal após gerar
    });

    // Função para chamar o backend Flask
    async function gerarApostaAleatoria(qtdeNum, qtdeTrevos) {
      try {
        mostrarMensagem('🎲 Gerando sua aposta...', 'info');
        
        // Para compatibilidade com o backend, dividimos os trevos em 2 grupos
        const qtdeTrevo1 = Math.ceil(qtdeTrevos / 2);
        const qtdeTrevo2 = Math.floor(qtdeTrevos / 2);
        
        const response = await fetch('/api/gerar-aposta-milionaria', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            qtde_num: qtdeNum,
            qtde_trevo1: qtdeTrevo1,
            qtde_trevo2: qtdeTrevo2
          })
        });

        if (!response.ok) {
          throw new Error(`Erro HTTP: ${response.status}`);
        }

        const data = await response.json();
        console.log("Aposta Gerada:", data);
        
        // Limpar seleções anteriores
        limparSelecaoSilenciosa();
        
        // Atualizar limite de trevos baseado no modal
        const limiteTrevos = qtdeTrevos;
        
        // Selecionar números aleatórios automaticamente
        data.numeros.forEach(numero => {
          const elementos = document.querySelectorAll('#numeros-container .numero');
          const elemento = Array.from(elementos).find(el => el.textContent.trim() === numero.toString().padStart(2, '0'));
          if (elemento) {
            selecionarNumeroAutomatico(numero, elemento);
          }
        });
        
        // Selecionar múltiplos números para Trevos (corrigido para usar a nova estrutura)
        const trevoElementos = document.querySelectorAll('#trevos-container .trevo-icon-container');
        
        // Função para selecionar trevo sem validação de limite (para geração automática)
        function selecionarTrevoAutomatico(trevo, elemento) {
          if (!trevosSelecionados.includes(trevo)) {
            trevosSelecionados.push(trevo);
            elemento.classList.add('selecionado');
          }
          atualizarTrevosSelecionados();
        }
        
        // Selecionar múltiplos números para Trevo 1
        if (Array.isArray(data.trevo1)) {
          data.trevo1.forEach(trevo => {
            const trevoElemento = Array.from(trevoElementos).find(el => 
              el.querySelector('.trevo-number').textContent.trim() === trevo.toString()
            );
            if (trevoElemento) {
              selecionarTrevoAutomatico(trevo, trevoElemento);
            }
          });
        } else {
          // Fallback para compatibilidade (trevo único)
          const trevoElemento = Array.from(trevoElementos).find(el => 
            el.querySelector('.trevo-number').textContent.trim() === data.trevo1.toString()
          );
          if (trevoElemento) {
            selecionarTrevoAutomatico(data.trevo1, trevoElemento);
          }
        }
        
        // Selecionar múltiplos números para Trevo 2
        if (Array.isArray(data.trevo2)) {
          data.trevo2.forEach(trevo => {
            const trevoElemento = Array.from(trevoElementos).find(el => 
              el.querySelector('.trevo-number').textContent.trim() === trevo.toString()
            );
            if (trevoElemento) {
              selecionarTrevoAutomatico(trevo, trevoElemento);
            }
          });
        } else {
          // Fallback para compatibilidade (trevo único)
          const trevoElemento = Array.from(trevoElementos).find(el => 
            el.querySelector('.trevo-number').textContent.trim() === data.trevo2.toString()
          );
          if (trevoElemento) {
            selecionarTrevoAutomatico(data.trevo2, trevoElemento);
          }
        }
        
        // Atualizar valor da aposta
        atualizarValorAposta(data.valor, data.qtde_apostas, qtdeNum, qtdeTrevos, qtdeTrevos);
        
        mostrarMensagem(`✅ Aposta gerada com sucesso! ${data.qtde_apostas} combinações`, 'success');

      } catch (error) {
        console.error("Erro ao gerar aposta:", error);
        mostrarMensagem(`❌ Erro ao gerar aposta: ${error.message}`, 'error');
      }
    }
  </script>







  <!-- Popup de Ajuda -->
  <div id="popupAjuda" class="modal-ajuda">
    <div class="modal-content">
      <span class="close" onclick="fecharPopupAjuda()">×</span>
      <h2>🧠 Entendendo os Gráficos</h2>
      <p>Esses gráficos mostram padrões que podem te ajudar a escolher seus números com mais estratégia.</p>

      <h3>📊 Frequência Absoluta</h3>
      <p>
        Quantas vezes cada número ou trevo foi sorteado.<br>
        <strong>✔ Útil para:</strong> ver os mais e menos sorteados até hoje.
      </p>

      <h3>📈 Frequência Relativa</h3>
      <p>
        Mostra a frequência em porcentagem, comparando com o esperado em sorteios aleatórios.<br>
        <strong>✔ Útil para:</strong> saber se um número saiu mais ou menos do que o "normal".
      </p>

      <h3>🔥 Números Quentes</h3>
      <p>
        São os que mais saíram recentemente. Alguns jogadores acreditam que estão em "alta".
      </p>

      <h3>❄️ Números Frios</h3>
      <p>
        São os que há tempos não aparecem. Alguns apostadores preferem dar chance a eles.
      </p>

      <h3>🕒 Análise Temporal</h3>
      <p>
        Compara os números mais frequentes em blocos (últimos 10%, 20%, 30% dos concursos).<br>
        <strong>✔ Útil para:</strong> detectar tendências mais recentes.
      </p>

      <p style="margin-top: 20px; font-style: italic;">
        Estes gráficos <strong>não garantem acertos</strong>, mas ajudam a apostar com mais consciência estatística.
      </p>
    </div>
  </div>

  <!-- Popup de Ajuda para Distribuição -->
  <div id="popupAjudaDistribuicao" class="modal-ajuda">
    <div class="modal-content">
      <span class="close" onclick="fecharPopupAjudaDistribuicao()">×</span>
      <h2>🧠 Entendendo a Análise de Distribuição</h2>
      <p>Esta análise revela a "forma" como os números e trevos se comportam, mostrando padrões estatísticos, desequilíbrios, aglomerados e dispersão. Compreender esses padrões pode guiar suas escolhas com mais estratégia.</p>

      <h3>📊 Paridade (Pares vs Ímpares)</h3>
      <p>
        O que mostra: A frequência de sorteios com diferentes combinações de números pares e ímpares para os números principais e trevos. (Ex: 3 Pares-3 Ímpares, 4 Pares-2 Ímpares, etc.).<br>
        <strong>✔ Útil para:</strong> Equilibrar sua aposta e identificar padrões comuns ou combinações historicamente raras.<br>
        <strong>💡 Dica:</strong> A maioria dos sorteios tem 3 números pares e 3 números ímpares.
      </p>

      <h3>🔢 Distribuição por Faixas Numéricas</h3>
      <p>
        O que mostra: Quantas vezes os números sorteados caem em diferentes faixas numéricas (1-10, 11-20, etc.). Também exibe a média e a moda de ocorrências por faixa.<br>
        <strong>✔ Útil para:</strong> Observar se algumas faixas são historicamente mais sorteadas do que outras.<br>
        <strong>💡 Dica:</strong> Ajuda a balancear sua aposta para incluir números de faixas mais ativas ou, se preferir, de faixas menos exploradas.
      </p>

      <h3>➕ Soma dos Números Principais</h3>
      <p>
        O que mostra: Um histograma da frequência da soma total dos 6 números principais sorteados. Apresenta também o valor mínimo, máximo, a média e a(s) moda(s) das somas.<br>
        <strong>✔ Útil para:</strong> Escolher combinações com somas que estejam dentro da faixa de valores mais comuns historicamente.<br>
        <strong>💡 Dica:</strong> Evite somas muito altas ou muito baixas, que são estatisticamente menos frequentes.
      </p>

      <h3>🍀 Soma dos Trevos da Sorte</h3>
      <p>
        O que mostra: Um histograma da distribuição das somas dos 2 trevos da sorte. Exibe o mínimo, máximo, média e a(s) moda(s) das somas dos trevos.<br>
        <strong>✔ Útil para:</strong> Escolher trevos que somem valores que ocorrem com mais frequência nos sorteios.<br>
        <strong>💡 Dica:</strong> Trevos com soma entre 3 e 7 são historicamente mais comuns.
      </p>

      <h3>↔️ Amplitude dos Números Principais</h3>
      <p>
        O que mostra: Um histograma da frequência da diferença entre o maior e o menor número sorteado em cada concurso. (Ex: Números 1 e 50 = amplitude 49).<br>
        <strong>✔ Útil para:</strong> Avaliar a "dispersão" dos números sorteados e evitar apostar em números muito próximos ou muito distantes entre si.<br>
        <strong>💡 Dica:</strong> Amplitudes entre 30 e 45 são as mais frequentes historicamente.
      </p>

      <h3>🎯 Como Usar na Prática</h3>
      <p>
        <strong>Observe os picos nos histogramas:</strong> Eles indicam as faixas de valores mais comuns (para somas e amplitudes).<br>
        <strong>Busque o equilíbrio:</strong> Evite combinações muito extremas (ex: muitos pares/ímpares, somas muito altas/baixas, amplitudes incomuns) que são menos frequentes historicamente.<br>
        <strong>Use como referência, não como regra absoluta:</strong> As estatísticas são ferramentas para auxiliar, não garantias.<br>
        <strong>Combine com outras análises:</strong> Para uma estratégia mais robusta, utilize estas informações em conjunto com a Análise de Frequência e outras ferramentas disponíveis.
      </p>

      <p style="margin-top: 20px; font-style: italic;">
        <strong>Importante:</strong> A Loteria é um jogo de azar. Estas análises estatísticas não garantem acertos, mas ajudam você a criar apostas mais equilibradas e estatisticamente mais prováveis, baseadas em dados históricos reais.
      </p>
    </div>
  </div>

  <!-- Popup de Ajuda para Afinidades -->
  <div id="popupAjudaAfinidades" class="modal-ajuda">
    <div class="modal-content">
      <span class="close" onclick="fecharPopupAjudaAfinidades()">×</span>
      <h2>🤝 Entendendo a Análise de Afinidade entre Números</h2>
      <p>Esta análise revela quais números têm maior tendência de aparecer juntos nos sorteios, baseada em dados históricos reais. Compreender essas afinidades pode ajudar você a criar combinações mais estratégicas.</p>

      <h3>🔗 Pares com Maior Afinidade</h3>
      <p>
        O que mostra: Os pares de números que mais frequentemente saem juntos nos sorteios. Por exemplo, se os números 21 e 22 aparecem juntos 15 vezes, eles têm alta afinidade.<br>
        <strong>✔ Útil para:</strong> Identificar números que "gostam" de sair juntos, podendo incluir ambos ou evitar ambos em sua aposta.<br>
        <strong>💡 Dica:</strong> Alguns jogadores preferem incluir pares com alta afinidade, outros evitam para não "concentrar" a aposta.
      </p>

      <h3>⭐ Afinidade Geral por Número</h3>
      <p>
        O que mostra: A pontuação total de afinidade de cada número com todos os outros. Números com alta pontuação são mais "sociais" e tendem a aparecer com mais frequência em diferentes combinações.<br>
        <strong>✔ Útil para:</strong> Identificar números que são mais "ativos" nos sorteios e podem ser bons candidatos para suas apostas.<br>
        <strong>💡 Dica:</strong> Números com alta afinidade geral são frequentemente escolhidos por muitos jogadores.
      </p>

      <h3>📊 Interpretando os Gráficos</h3>
      <p>
        <strong>Gráfico de Pares:</strong> Mostra os pares com maior afinidade em ordem decrescente. Barras mais altas indicam pares que saem juntos com mais frequência.<br>
        <strong>Gráfico de Afinidade Geral:</strong> Mostra a pontuação total de cada número. Números com barras mais altas são mais "sociais" nos sorteios.
      </p>

      <h3>🎯 Estratégias de Uso</h3>
      <p>
        <strong>Estratégia de Inclusão:</strong> Incluir pares com alta afinidade em sua aposta, pois eles têm histórico de sair juntos.<br>
        <strong>Estratégia de Evitação:</strong> Evitar pares com alta afinidade para não "concentrar" demais sua aposta.<br>
        <strong>Estratégia Mista:</strong> Usar números com alta afinidade geral como base e complementar com números menos frequentes.<br>
        <strong>Balanceamento:</strong> Combinar números com diferentes níveis de afinidade para criar apostas mais equilibradas.
      </p>

      <h3>⚠️ Considerações Importantes</h3>
      <p>
        <strong>Correlação não é causalidade:</strong> Números com alta afinidade não "causam" o sorteio um do outro, apenas têm histórico de aparecer juntos.<br>
        <strong>Padrões podem mudar:</strong> Afinidades baseadas em dados históricos podem não se repetir no futuro.<br>
        <strong>Use com moderação:</strong> Não dependa exclusivamente da afinidade, combine com outras análises.
      </p>

      <p style="margin-top: 20px; font-style: italic;">
        <strong>Importante:</strong> A Loteria é um jogo de azar. Estas análises de afinidade não garantem acertos, mas ajudam você a entender padrões históricos e criar apostas mais informadas, baseadas em dados reais dos sorteios.
      </p>
    </div>
  </div>

  <!-- CSS para o popup de ajuda e gráficos responsivos -->
  <style>
  .modal-ajuda {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.85);
  }

  /* Gráficos responsivos */
  .chart-container {
    padding: 10px;
    margin: 10px 0;
  }

  @media (max-width: 768px) {
    .chart-container {
      padding: 5px;
      margin: 5px 0;
    }
    
    .chart-container h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .chart-container div[id^="grafico-"] {
      height: 350px !important; /* Aumenta ainda mais sem títulos de eixo */
      width: 100% !important;
    }
  }

  @media (max-width: 640px) {
    .chart-container div[id^="grafico-"] {
      height: 310px !important; /* Aumenta ainda mais sem títulos de eixo */
    }
    
    /* Otimizações específicas para gráficos Plotly em mobile */
    .js-plotly-plot .plotly .modebar {
      display: none !important;
    }
    
    /* Esconde legendas em mobile para economizar espaço */
    .js-plotly-plot .plotly .legend {
      display: none !important;
    }
    
    .js-plotly-plot .plotly .legend .traces {
      display: none !important;
    }
  }

  /* Mostra legendas em desktop */
  @media (min-width: 769px) {
    .js-plotly-plot .plotly .legend {
      display: block !important;
      font-size: 11px !important;
    }
    
    .js-plotly-plot .plotly .legend .traces {
      display: block !important;
      font-size: 11px !important;
    }
  }

  .modal-ajuda .modal-content {
    background-color: #1c1c1c;
    color: #eee;
    margin: 10% auto;
    padding: 20px;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh; /* Limita altura máxima */
    overflow-y: auto; /* Permite rolagem vertical */
    -webkit-overflow-scrolling: touch; /* Melhora rolagem em iOS */
    scroll-behavior: smooth; /* Scroll suave */
    font-family: 'Inter', sans-serif;
    box-shadow: 0 0 20px #000;
  }

  .modal-ajuda .close {
    color: #aaa;
    float: right;
    font-size: 26px;
    cursor: pointer;
  }

  .modal-ajuda .close:hover {
    color: red;
  }

  .modal-ajuda h2 {
    color: #00E38C;
    margin-bottom: 15px;
  }

  .modal-ajuda h3 {
    color: #00E38C;
    margin-top: 20px;
    margin-bottom: 10px;
  }

  .modal-ajuda p {
    line-height: 1.6;
    margin-bottom: 10px;
  }

  /* Otimizações mobile para modal de ajuda */
  @media (max-width: 768px) {
    .modal-ajuda .modal-content {
      margin: 5% auto; /* Reduz margem superior */
      width: 95%; /* Ocupa mais largura */
      padding: 15px; /* Reduz padding */
    }
  }

  @media (max-width: 640px) {
    .modal-ajuda .modal-content {
      margin: 3% auto; /* Margem ainda menor */
      width: 98%; /* Quase toda a largura */
      padding: 12px; /* Padding menor */
    }
  }
  </style>

  <script src="{{ url_for('static', filename='js/graficos.js') }}"></script>
</body>
</html> 